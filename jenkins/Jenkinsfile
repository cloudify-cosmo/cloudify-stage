@Library('pipeline-shared-library')

pipeline {
  agent {
    kubernetes {
      label 'java-rest-client'
      defaultContainer 'jnlp'
      yamlFile 'jenkins/build-pod.yaml'
    }
  }

  options {
    checkoutToSubdirectory('cloudify-java-rest-client')
    buildDiscarder(logRotator(numToKeepStr:'30'))
    timeout(time: 60, unit: 'MINUTES')
    timestamps()
  }

  environment {
    BRANCH = "${env.BRANCH_NAME}"
    WORKSPACE = "${env.WORKSPACE}"
    PROJECT = "cloudify-ui-components"
  }

  stages {
    stage('Compile') {
      steps {
        container('mvn'){
          dir("${env.WORKSPACE}/${env.PROJECT}") {
            echo "Maven Clean Compile"
            sh 'mvn clean compile'
          }
        }
      }
    }

    stage('Test') {
      steps {
        container('mvn'){
          dir("${env.WORKSPACE}/${env.PROJECT}") {
            echo "Maven Test"
            sh 'mvn test'
          }
        }
      }
    }

    stage('Install') {
      steps {
        container('mvn'){
          dir("${env.WORKSPACE}/${env.PROJECT}") {
            echo "Maven Install"
            sh 'mvn install'
          }
        }
      }
    }
    
    stage('Deploy') {
      when {
        expression { return env.BRANCH =~ /^publish-v.*/ }
      }
      steps {
        container('mvn'){
          dir("${env.WORKSPACE}/${env.PROJECT}") {
            echo "Maven Deploy"
            sh 'mvn clean deploy'
          }
        }
      }
    }
  }
}
